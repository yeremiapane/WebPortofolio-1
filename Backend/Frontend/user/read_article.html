<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Articles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Font Inter dari Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

  <!-- Ionicons (untuk ikon like dll.) -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

  <!-- Quill CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" rel="stylesheet">

  <!-- Include the highlight.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

  <style>
    /* -------------------- RESET & GLOBAL -------------------- */
    * {
      margin: 0; padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #fff;
      color: #333;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    /* -------------------- HEADER -------------------- */
    .header-container {
      background: #ffffff;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding: 32px;
    }
    .header-inner {
      max-width: 70rem;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logo img {
      height: 40px;
    }
    .header-social a {
      margin-left: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Tambahkan di dalam tag <style> atau file CSS Anda */
    .header-inner ul {
      display: flex;
      list-style: none;
      gap: 24px; /* Atur jarak sesuai kebutuhan */
      margin: 0;
      padding: 0;
    }

    .header-inner a {
      font-weight: 600;
      color: #333;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .header-inner a:hover {
      background-color: #f0f0f0;
      color: #171717;
      transform: scale(1.02);
    }

    /* -------------------- HERO / ARTICLE HEADER -------------------- */
    .hero-section {
      padding-top: 40px;
      padding-bottom: 80px;
    }
    .hero-inner {
      max-width: 70rem;
      margin: 0 auto;
      padding: 0 32px;
      text-align: center;
    }
    .hero-tag {
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.025em;
      color: #666;
      margin-bottom: 4px;
      display: inline-block;
    }
    .hero-title {
      font-size: 48px;
      font-weight: 400;
      margin: 0.2em 0;
      letter-spacing: -0.05em;
      line-height: 1.2;
    }
    .hero-info {
      font-size: 16px;
      color: #666;
      margin-top: 8px;
    }
    .hero-image {
      margin: 56px auto 0 auto;
      border-radius: 24px;
      max-width: 100%;
      height: 500px;
      width: 800px;
    }

    /* ---------------------- */
    /* Styling untuk blockquote, code, pre, dsb. */
    /* ---------------------- */

    /* BLOCKQUOTE: */
    .ql-editor blockquote {
      border-left: 4px solid #ccc;
      margin: 1em 0;
      padding-left: 1em;
      color: #666;
      font-style: italic;
    }

    /* CODE INLINE: */
    .ql-editor code {
      background-color: #100f0f;
      padding: 2px 4px;
      border-radius: 4px;
      font-family: Consolas, Menlo, Monaco, "Courier New", monospace;
      font-size: 90%;
    }

    /* CODE BLOCK (PRE TAG): */
    .ql-editor pre {
      background-color: #100f0f;
      border-radius: 6px;
      padding: 1em;
      overflow-x: auto;
      font-family: Consolas, Menlo, Monaco, "Courier New", monospace;
      font-size: 90%;
      margin: 1em 0;
    }

    /* JIKA ADA syntax highlight (pre.ql-syntax) dari quill-syntax: */
    .ql-editor pre.ql-syntax {
      background-color: #282c34; /* Contoh latar belakang gelap */
      color: #eee;              /* Warna teks default */
    }

    /* Anda bisa menambahkan styling detail untuk token code highlight,
       tetapi itu memerlukan integrasi highlight.js atau prism.js misalnya. */


    /* Tampilkan tags dalam bentuk bulatan/pill */
    .tags-wrap {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tag-item {
      background: #f0f0f0;
      padding: 6px 12px;
      border-radius: 14px;
      font-size: 12px;
      color: #333;
      display: inline-block;
    }

    /* -------------------- MAIN CONTENT -------------------- */
    .content-wrap {
      max-width: 768px;
      margin: 0 auto;
      padding: 0 32px;
      text-align: justify;
    }
    .content-wrap p {
      font-size: 18px;
      line-height: 1.625em;
      margin-bottom: 24px;
    }
    .content-wrap h3 {
      font-size: 24px;
      margin-top: 40px;
      margin-bottom: 8px;
      font-weight: 500;
    }

    /* Quill content styling (untuk isi artikel) */
    .ql-editor {
      font-size: 18px;
      line-height: 1.625em;
    }

    /* -------------------- LIKE & COMMENT COUNT -------------------- */
    .engagement-info {
      max-width: 768px;
      margin: 30px auto;
      padding: 0 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #666;
      font-size: 16px;
    }
    .like-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .like-section button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
    }
    .like-section button.liked ion-icon {
      color: red;
    }

    /* -------------------- COMMENT SECTION -------------------- */
    .comments-section {
      max-width: 768px;
      margin: 0 auto;
      padding: 40px 32px;
      border-top: 1px solid #eee;
    }
    .comments-section h3 {
      margin-bottom: 16px;
      font-size: 24px;
    }
    .toggle-anonymous {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }
    .comment-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 32px;
    }
    .comment-form label {
      font-weight: 500;
      margin-bottom: 4px;
    }
    .comment-form input,
    .comment-form textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
      outline: none;
    }
    .comment-quill-container {
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #comment-editor {
      height: 100px;
    }
    .btn-submit-comment {
      width: fit-content;
      background-color: #171717;
      color: #fff;
      padding: 10px 18px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    .btn-submit-comment:hover {
      background-color: #333;
    }

    /* Daftar komentar */
    .comments-list {
      margin-top: 40px;
    }
    .single-comment {
      margin-bottom: 20px;
    }
    .comment-author {
      font-weight: 600;
      margin-bottom: 6px;
    }
    .comment-content {
      background-color: #f7f7f7;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    .comment-actions {
      display: flex;
      gap: 10px;
      font-size: 0.9rem;
      color: #666;
      cursor: pointer;
    }
    .reply-list {
      padding-left: 20px;
      margin-top: 10px;
      border-left: 2px solid #ddd;
    }

    /* -------------------- RELATED ARTICLES -------------------- */

    .another-post h3{
      text-align: center;
      margin-bottom: 16px;
      font-size: 24px;

    }

    .related-articles {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: center;
      margin-bottom: 40px;
    }

    .related-article-card {
      background-color: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      width: 280px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
    }

    .related-article-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .related-article-image {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }

    .related-article-content {
      padding: 16px;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .related-article-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      flex: 1;
    }

    .related-article-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #777;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .meta-item ion-icon {
      font-size: 16px;
      color: #555;
    }

    .footer-container {
      background-color: #171717; /* Background gelap */
      color: #ffffff;
      padding: 40px 0;
    }

    .footer-inner {
      max-width: 70rem;
      margin: 0 auto;
      text-align: center;
      font-size: 16px;
    }

    .footer-social {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .footer-social ion-icon {
      font-size: 24px;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .footer-social ion-icon:hover {
      color: #f0f0f0; /* Ubah warna saat hover */
    }

    /* -------------------- ALERT SYSTEM -------------------- */
    .alert-container {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      z-index: 1000;
    }

    .alert {
      display: flex;
      align-items: center;
      background-color: #fff;
      color: #333;
      padding: 12px 16px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      opacity: 0;
      transform: translateX(100%);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .alert.show {
      opacity: 1;
      transform: translateX(0);
    }

    .alert.success {
      border-left: 6px solid #4caf50; /* Hijau untuk sukses */
    }

    .alert.error {
      border-left: 6px solid #f44336; /* Merah untuk error */
    }

    .alert .alert-icon {
      margin-right: 12px;
      font-size: 20px;
    }

    .alert .alert-message {
      flex: 1;
    }

    .alert .close-btn {
      background: none;
      border: none;
      color: #777;
      cursor: pointer;
      font-size: 20px;
      padding: 0;
    }


    /* -------------------- RESPONSIVE -------------------- */
    @media (max-width: 768px) {
      .hero-title {
        font-size: 36px;
      }
      .header-inner, .hero-inner, .content-wrap {
        padding: 0 20px;
      }
      .hero-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
    }
  </style>
</head>
<body>
<!-- Alert Container -->
<div class="alert-container" id="alertContainer"></div>

<!-- HEADER -->
<header class="header-container">
  <div class="header-inner">
    <a class="header-logo" href="#">
      <!-- Ganti src logo sesuai kebutuhan -->
      <img src="/assets/img/logo.png" alt="Logo">
    </a>
    <ul>
      <li><a href="/blog">Home</a></li>
      <li><a href="/">About</a></li>
      <li><a href="/pages/contact-form.html">Contact</a> </li>
    </ul>
  </div>
</header>

<!-- HERO SECTION -->
<section class="hero-section">
  <div class="hero-inner">
    <!-- Kategori / Tag utama -->
    <span class="hero-tag" id="articleCategory">Kategori</span>

    <!-- Judul artikel -->
    <h1 class="hero-title" id="articleTitle">Judul Artikel Dinamis</h1>

    <!-- Informasi penulis, tanggal publish, updated, waktu baca -->
    <div class="hero-info" id="articleInfo">
      <!-- Contoh: Author: John Doe | Published at: ... | Updated at: ... | 5 menit baca -->
    </div>

    <!-- Tags (dipisahkan dengan koma, tapi ditampilkan seperti shape/pill) -->
    <div class="tags-wrap" id="tagsWrap">
      <!-- Tag-item akan diinject via JS -->
    </div>

    <!-- Main Image (Hero Image) -->
    <img class="hero-image"
         id="articleMainImage"
         src=""
         alt="Hero Image">
  </div>
</section>

<!-- MAIN CONTENT (Load dari database, ditulis dengan Quill) -->
<section class="content-wrap">
  <!-- Konten artikel akan di-render di sini -->
  <div class="ql-editor" id="articleContent"></div>
</section>

<!-- LIKE & COMMENT COUNT -->
<div class="engagement-info">
  <div class="like-section">
    <button id="likeBtn">
      <ion-icon name="heart-outline"></ion-icon>
    </button>
    <span id="likeCount">0</span>
  </div>
  <div class="comment-count">
    <span id="commentCountText">0 Komentar</span>
  </div>
</div>

<!-- COMMENTS SECTION -->
<div class="comments-section" id="commentsSection">
  <h3>Tinggalkan Komentar</h3>

  <div class="toggle-anonymous">
    <input type="checkbox" id="anonymousToggle" />
    <label for="anonymousToggle">Komentar secara anonim</label>
  </div>

  <form class="comment-form" id="commentForm">
    <div id="namedFields">
      <div>
        <label for="name">Nama:</label>
        <input type="text" id="name" placeholder="Nama" required />
      </div>
      <div>
        <label for="email">Email:</label>
        <input type="email" id="email" placeholder="Email" required />
      </div>
    </div>
    <div>
      <label for="comment-editor">Komentar:</label>
      <div class="comment-quill-container">
        <div id="comment-editor"></div>
      </div>
    </div>
    <button type="submit" class="btn-submit-comment">Kirim Komentar</button>
  </form>

  <!-- Daftar komentar -->
  <div class="comments-list" id="commentsList">
    <h3>Daftar Komentar</h3>
    <!-- Komentar akan di-render di sini secara dinamis -->
  </div>
</div>

<!-- ANOTHER POST (Artikel Terkait) -->
<div class="another-post">
  <h3>Artikel Terkait</h3>
  <div class="related-articles" id="relatedArticles">
    <!-- Artikel terkait akan diisi secara dinamis di sini -->
  </div>
</div>


<footer class="footer-container">
  <div class="footer-inner">
    <p>Â© 2025 Yeremia Yosefan Pane. All rights reserved.</p>
    <div class="footer-social">
      <a href="//www.twitter.com" target="_blank">
        <ion-icon name="logo-twitter"></ion-icon>
      </a>
      <a href="//www.facebook.com" target="_blank">
        <ion-icon name="logo-facebook"></ion-icon>
      </a>
      <a href="//www.instagram.com" target="_blank">
        <ion-icon name="logo-instagram"></ion-icon>
      </a>
    </div>
  </div>
</footer>



<!-- Quill JS -->
<script>
  // -------------------------------------------------------
  // 1. Ambil articleId dari URL (misal path: /article/123)
  // -------------------------------------------------------
  const articleId = (() => {
    const pathParts = window.location.pathname.split("/");
    return pathParts[pathParts.length - 1];
  })();

  const toolbarOptions = [
    ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
    ['blockquote', 'code-block'],
    ['link', 'image', 'video', 'formula'],

    [{ 'header': 1 }, { 'header': 2 }],               // custom button values
    [{ 'list': 'ordered'}, { 'list': 'bullet' }, { 'list': 'check' }],
    [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
    [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
    [{ 'direction': 'rtl' }],                         // text direction

    [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

    [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
    [{ 'font': [] }],
    [{ 'align': [] }],

    ['clean']                                         // remove formatting button
  ];
  // -------------------------------------------------------
  // 2. Inisialisasi Editor Quill untuk form komentar
  // -------------------------------------------------------
  const commentEditor = new Quill('#comment-editor', {
    modules: {
      syntax: true,              // Include syntax module
      toolbar: toolbarOptions  // Include button in toolbar
    },
    theme: 'snow'
  });

  // -------------------------------------------------------
  // 3. Fetch Detail Artikel
  // -------------------------------------------------------
  async function fetchArticleDetail() {
    try {
      const response = await fetch(`/articles/${articleId}`, {
        method: 'GET',
        credentials: 'include'
      });
      if (!response.ok) {
        throw new Error('Failed to fetch article detail');
      }
      const article = await response.json();

      // isi hero section
      document.getElementById('articleTitle').textContent = article.Title;
      document.getElementById('articleCategory').textContent = article.Category || 'Kategori';
      // Info penulis, publish, update, reading time
      const infoEl = document.getElementById('articleInfo');
      let htmlInfo = `Author: <strong>${article.Publisher}</strong> | Published at: <strong>${new Date(article.CreatedAt).toLocaleDateString()}</strong>`;

      // Updated at
      const createdTime = new Date(article.CreatedAt);
      const updatedTime = new Date(article.UpdatedAt);
      if (updatedTime > createdTime) {
        htmlInfo += ` | Updated at: <strong>${updatedTime.toLocaleDateString()}</strong>`;
      }
      // ReadingTime (misalnya '5 menit baca')
      htmlInfo += ` | ${article.ReadingTime} menit baca`;
      infoEl.innerHTML = htmlInfo;

      // Tampilkan mainImage
      const mainImageEl = document.getElementById('articleMainImage');
      if (article.MainImage) {
        mainImageEl.src = `/${article.MainImage}`;  // sesuaikan path sesuai server
      } else {
        mainImageEl.style.display = 'none';
      }

      // Tampilkan tags
      const tagsWrap = document.getElementById('tagsWrap');
      tagsWrap.innerHTML = '';
      if (article.Tags) {
        const tagArr = article.Tags.split(',');
        tagArr.forEach(tag => {
          const t = tag.trim();
          if (t) {
            const span = document.createElement('span');
            span.classList.add('tag-item');
            span.textContent = t;
            tagsWrap.appendChild(span);
          }
        });
      }

      // Konten artikel (asumsi format Quill HTML sudah disimpan)
      const articleContent = document.getElementById('articleContent');
      articleContent.innerHTML = article.Content || '';

      // Update likeCount
      document.getElementById('likeCount').textContent = article.Likes || 0;

    } catch (error) {
      console.error('Error fetching article detail:', error);
    }
  }

  // -------------------------------------------------------
  // 4. Fetch Status Like
  // -------------------------------------------------------
  let liked = false; // state awal
  async function fetchLikeStatus() {
    try {
      const resp = await fetch(`/articles/${articleId}/like_status`, {
        method: 'GET',
        credentials: 'include'
      });
      if (!resp.ok) {
        throw new Error('Failed to get like status');
      }
      const data = await resp.json();
      const likeCountEl = document.getElementById('likeCount');
      likeCountEl.textContent = data.likes;
      liked = data.liked;

      // Update tombol
      const likeBtn = document.getElementById('likeBtn');
      likeBtn.classList.toggle('liked', liked);
      const icon = likeBtn.querySelector('ion-icon');
      if (liked) {
        icon.setAttribute('name', 'heart');
      } else {
        icon.setAttribute('name', 'heart-outline');
      }
    } catch (error) {
      console.error('Error fetching like status:', error);
    }
  }

  // 5. Toggle Like / Unlike
  const likeBtn = document.getElementById('likeBtn');
  likeBtn.addEventListener('click', async () => {
    try {
      const resp = await fetch(`/articles/${articleId}/toggle_like`, {
        method: 'POST',
        credentials: 'include'
      });
      if (!resp.ok) {
        throw new Error('Failed to toggle like');
      }
      const data = await resp.json();
      const likeCountEl = document.getElementById('likeCount');
      likeCountEl.textContent = data.likes;
      liked = data.liked;

      // Update ikon
      likeBtn.classList.toggle('liked', liked);
      const icon = likeBtn.querySelector('ion-icon');
      if (liked) {
        icon.setAttribute('name', 'heart');
        showAlert('Berhasil menyukai artikel!, Terima kasihðŸ˜‡', 'success');
      } else {
        icon.setAttribute('name', 'heart-outline');
        showAlert('Berhasil membatalkan like!', 'success');
      }
    } catch (error) {
      console.error('Error toggling like:', error);
      showAlert('Gagal melakukan like/unlike.', 'error');
    }
  });


  // -------------------------------------------------------
  // 6. Fetch Comments
  // -------------------------------------------------------
  async function fetchComments() {
    try {
      const resp = await fetch(`/articles/${articleId}/comments`, {
        method: 'GET',
        credentials: 'include'
      });
      if (!resp.ok) {
        throw new Error('Failed to fetch comments');
      }
      const data = await resp.json();
      const comments = data.Comments || []; // Tetapkan ke array kosong jika undefined/null

      // Render comments
      renderComments(comments);
    } catch (error) {
      console.error('Error fetching comments:', error);
    }
  }


  function renderComments(commentTree) {
    const commentsList = document.getElementById('commentsList');
    commentsList.innerHTML = '<h3>Daftar Komentar</h3>'; // Reset dan tambahkan header

    if (!Array.isArray(commentTree)) {
      console.warn('Comment tree is not an array:', commentTree);
      return; // Tidak ada komentar untuk ditampilkan
    }

    // Count total comments
    let totalComments = 0;

    function createCommentElement(cmt) {
      totalComments++;
      const singleComment = document.createElement('div');
      singleComment.classList.add('single-comment');
      singleComment.dataset.commentid = cmt.id;

      // Author
      const authorDiv = document.createElement('div');
      authorDiv.classList.add('comment-author');
      authorDiv.textContent = cmt.name;
      singleComment.appendChild(authorDiv);

      // Content
      const contentDiv = document.createElement('div');
      contentDiv.classList.add('comment-content');
      contentDiv.innerHTML = cmt.content;
      singleComment.appendChild(contentDiv);

      // Actions
      const actionsDiv = document.createElement('div');
      actionsDiv.classList.add('comment-actions');
      const replySpan = document.createElement('span');
      replySpan.classList.add('reply-btn');
      replySpan.textContent = 'Balas';
      replySpan.setAttribute('data-replyto', cmt.id);
      actionsDiv.appendChild(replySpan);
      singleComment.appendChild(actionsDiv);

      // Child replies
      if (cmt.children && Array.isArray(cmt.children) && cmt.children.length > 0) {
        const replyList = document.createElement('div');
        replyList.classList.add('reply-list');
        cmt.children.forEach(child => {
          replyList.appendChild(createCommentElement(child));
        });
        singleComment.appendChild(replyList);
      }

      return singleComment;
    }

    commentTree.forEach(cmt => {
      const cmtEl = createCommentElement(cmt);
      commentsList.appendChild(cmtEl);
    });

    // Update text "X Komentar"
    document.getElementById('commentCountText').textContent = totalComments + ' Komentar';
  }


  // -------------------------------------------------------
  // 7. Submit Comment
  // -------------------------------------------------------
  // ------------------ Toggle Anonymous ------------------
  const anonymousToggle = document.getElementById('anonymousToggle');
  const namedFields = document.getElementById('namedFields');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');

  anonymousToggle.addEventListener('change', (e) => {
    if (e.target.checked) {
      namedFields.style.display = 'none';
      nameInput.value = '';
      emailInput.value = '';
      // Hapus atribut 'required' saat anonim
      nameInput.removeAttribute('required');
      emailInput.removeAttribute('required');
    } else {
      namedFields.style.display = 'block';
      // Tambahkan kembali atribut 'required' saat tidak anonim
      nameInput.setAttribute('required', '');
      emailInput.setAttribute('required', '');
    }
  });


  const commentForm = document.getElementById('commentForm');
  let activeReplyTo = null; // ID komentar yang sedang direply (jika form dipindah)
  commentForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Ambil konten Quill
    const commentContent = commentEditor.root.innerHTML.trim();

    // Cek anon
    let isAnon = anonymousToggle.checked;
    let nameVal = nameInput.value.trim();
    let emailVal = emailInput.value.trim();

    if (!isAnon && (!nameVal || !emailVal)) {
      showAlert('Nama dan Email wajib diisi jika tidak anonim.', 'error');
      return;
    }

    if (commentContent === '' || commentContent === '<p><br></p>') {
      showAlert('Komentar tidak boleh kosong.', 'error');
      return;
    }

    if (isAnon) {
      nameVal = 'Anonymous';
      emailVal = '';
    }

    // parent_id (jika sedang reply)
    const parentId = activeReplyTo || '';

    // Kirim ke server
    const formData = new FormData();
    formData.append('parent_id', parentId);
    formData.append('name', nameVal);
    formData.append('email', emailVal);
    formData.append('content', commentContent);
    formData.append('is_anonymous', isAnon ? 'true' : 'false');

    try {
      const resp = await fetch(`/articles/${articleId}/comments`, {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });
      if (!resp.ok) {
        throw new Error('Gagal mengirim komentar');
      }
      const result = await resp.json();
      console.log('Komentar terkirim:', result);
      showAlert('Komentar berhasil dikirim!, Terima kasih atas masukannya', 'success');

      // Reset form
      commentEditor.root.innerHTML = '';
      if (!isAnon) {
        nameInput.value = '';
        emailInput.value = '';
      }
      activeReplyTo = null;

      // Form pindahkan balik ke comments-section (jika tadinya menempel di balasan)
      document.getElementById('commentsSection').appendChild(commentForm);

      // Refresh komentar
      fetchComments();
    } catch (error) {
      console.error('Error posting comment:', error);
      alert('Terjadi kesalahan saat mengirim komentar.');
      showAlert(`Gagal mengirim komentar! ${error.message}`);
    }
  });

  // -------------------------------------------------------
  // 8. Handle Balas Komentar (Memindah form)
  // -------------------------------------------------------
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('reply-btn')) {
      const commentId = e.target.getAttribute('data-replyto');
      const parentComment = document.querySelector(`.single-comment[data-commentid="${commentId}"]`);
      const replyList = parentComment.querySelector('.reply-list');

      // Pindahkan form ke dalam .reply-list
      replyList.appendChild(commentForm);
      activeReplyTo = commentId;

      // Kosongkan editor, nama, email (jika diinginkan)
      commentEditor.root.innerHTML = '';
      if (!anonymousToggle.checked) {
        nameInput.value = '';
        emailInput.value = '';
      }
    }
  });

  // 9. Fetch Artikel Terkait (Another Posts)
  async function fetchAnotherPosts() {
    try {
      // Panggil endpoint /articles untuk menampilkan beberapa artikel
      const resp = await fetch('/articles', {
        method: 'GET',
        credentials: 'include' // Sertakan cookie jika diperlukan
      });
      if (!resp.ok) {
        throw new Error('Failed to fetch related articles');
      }
      const allArticles = await resp.json();
      // Filter untuk tidak menampilkan artikel yang sedang dibaca
      const filtered = allArticles.filter(a => a.ID !== parseInt(articleId));
      const relatedContainer = document.getElementById('relatedArticles');
      relatedContainer.innerHTML = '';

      // Tampilkan 3 pertama
      const top3 = filtered.slice(0, 3);
      top3.forEach(a => {
        const card = document.createElement('div');
        card.classList.add('related-article-card');

        // Gambar Artikel
        const img = document.createElement('img');
        img.classList.add('related-article-image');
        img.src = `/${a.MainImage}`; // Sesuaikan path gambar
        img.alt = a.Title;
        card.appendChild(img);

        // Konten Artikel
        const content = document.createElement('div');
        content.classList.add('related-article-content');

        // Judul Artikel
        const title = document.createElement('a');
        title.classList.add('related-article-title');
        title.href = `/article/${a.ID}`;
        title.textContent = a.Title;
        content.appendChild(title);

        // Meta Info (Author, Likes, Comments)
        const meta = document.createElement('div');
        meta.classList.add('related-article-meta');

        // Author
        const author = document.createElement('div');
        author.classList.add('meta-item');
        const authorIcon = document.createElement('ion-icon');
        authorIcon.setAttribute('name', 'person-outline');
        author.appendChild(authorIcon);
        author.appendChild(document.createTextNode(a.Publisher));
        meta.appendChild(author);

        // Likes
        const likes = document.createElement('div');
        likes.classList.add('meta-item');
        const likeIcon = document.createElement('ion-icon');
        likeIcon.setAttribute('name', 'heart-outline');
        likes.appendChild(likeIcon);
        likes.appendChild(document.createTextNode(a.Likes));
        meta.appendChild(likes);

        // Comments
        const comments = document.createElement('div');
        comments.classList.add('meta-item');
        const commentIcon = document.createElement('ion-icon');
        commentIcon.setAttribute('name', 'chatbubble-outline');
        comments.appendChild(commentIcon);
        comments.appendChild(document.createTextNode(a.Comments));
        meta.appendChild(comments);

        content.appendChild(meta);
        card.appendChild(content);
        relatedContainer.appendChild(card);
      });
    } catch (error) {
      console.error('Error fetching related articles:', error);
    }
  }

  // Alert System
  function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alertContainer');
    if (!alertContainer) return;

    const alert = document.createElement('div');
    alert.classList.add('alert', type === 'success' ? 'success' : 'error');

    // Icon
    const icon = document.createElement('span');
    icon.classList.add('alert-icon');
    icon.innerHTML = type === 'success' ? '<ion-icon name="checkmark-circle-outline"></ion-icon>' : '<ion-icon name="close-circle-outline"></ion-icon>';
    alert.appendChild(icon);

    // Message
    const msg = document.createElement('span');
    msg.classList.add('alert-message');
    msg.textContent = message;
    alert.appendChild(msg);

    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.classList.add('close-btn');
    closeBtn.innerHTML = '&times;';
    closeBtn.onclick = () => {
      alert.classList.remove('show');
      setTimeout(() => alert.remove(), 300);
    };
    alert.appendChild(closeBtn);

    alertContainer.appendChild(alert);

    // Show alert
    setTimeout(() => {
      alert.classList.add('show');
    }, 10);

    // Hide after 3 seconds
    setTimeout(() => {
      alert.classList.remove('show');
      setTimeout(() => alert.remove(), 300);
    }, 3000);
  }


  // -------------------------------------------------------
  // 10. Inisialisasi saat halaman dimuat
  // -------------------------------------------------------
  document.addEventListener('DOMContentLoaded', async () => {
    await fetchArticleDetail();
    await fetchLikeStatus();
    await fetchComments();
    await fetchAnotherPosts();
  });
</script>
</body>
</html>
